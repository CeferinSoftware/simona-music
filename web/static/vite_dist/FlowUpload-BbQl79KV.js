import{f as B}from"./formatFileSize--9DaIXge.js";import{T as L,_ as A}from"./icons-BAjd3tML.js";import{a as M}from"./leaflet-DkUWBo0d.js";import{j as q,g as N}from"./layout-CUzOT8aY.js";import{f as H}from"./forEach-BFcv9GyE.js";import{d as $}from"./defaultsDeep-B9v54JJt.js";import{a as V}from"./estoolkit-DCzBkaPJ.js";import{d as X,x as G,g as D,h as J,ag as Y,c as y,o as S,a as m,F as U,D as Z,i as _,s as K,t as C,E as Q,f as W,u as P,b as ee}from"./vue-BsfewpWM.js";var E={exports:{}};/**
 * @license MIT
 */var R;function te(){return R||(R=1,(function(F){(function(v,d,b){if(!v||!d){console.warn("Flowjs needs window and document objects to work");return}var f=v.navigator.msPointerEnabled;function o(e){if(this.support=typeof File<"u"&&typeof Blob<"u"&&typeof FileList<"u"&&(!!Blob.prototype.slice||!!Blob.prototype.webkitSlice||!!Blob.prototype.mozSlice||!1),!!this.support){this.supportDirectory=/Chrome/.test(v.navigator.userAgent)||/Firefox/.test(v.navigator.userAgent)||/Edge/.test(v.navigator.userAgent),this.files=[],this.defaults={chunkSize:1024*1024,forceChunkSize:!1,simultaneousUploads:3,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,preprocess:null,changeRawDataBeforeSend:null,method:"multipart",testMethod:"GET",uploadMethod:"POST",prioritizeFirstAndLastChunk:!1,allowDuplicateUploads:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,413,415,500,501],successStatuses:[200,201,202],onDropStopPropagation:!1,initFileFn:null,readFileFn:k},this.opts={},this.events={};var t=this;this.onDrop=function(i){t.opts.onDropStopPropagation&&i.stopPropagation(),i.preventDefault();var s=i.dataTransfer;s.items&&s.items[0]&&s.items[0].webkitGetAsEntry?t.webkitReadDataTransfer(i):t.addFiles(s.files,i)},this.preventEvent=function(i){i.preventDefault()},this.opts=o.extend({},this.defaults,e||{})}}o.prototype={on:function(e,t){e=e.toLowerCase(),this.events.hasOwnProperty(e)||(this.events[e]=[]),this.events[e].push(t)},off:function(e,t){e!==b?(e=e.toLowerCase(),t!==b?this.events.hasOwnProperty(e)&&x(this.events[e],t):delete this.events[e]):this.events={}},fire:function(e,t){t=Array.prototype.slice.call(arguments),e=e.toLowerCase();var i=!1;return this.events.hasOwnProperty(e)&&r(this.events[e],function(s){i=s.apply(this,t.slice(1))===!1||i},this),e!="catchall"&&(t.unshift("catchAll"),i=this.fire.apply(this,t)===!1||i),!i},webkitReadDataTransfer:function(e){var t=this,i=e.dataTransfer.items.length,s=[];r(e.dataTransfer.items,function(u){var h=u.webkitGetAsEntry();if(!h){p();return}h.isFile?a(u.getAsFile(),h.fullPath):n(h.createReader())});function n(u){u.readEntries(function(h){h.length?(i+=h.length,r(h,function(z){if(z.isFile){var T=z.fullPath;z.file(function(I){a(I,T)},c)}else z.isDirectory&&n(z.createReader())}),n(u)):p()},c)}function a(u,h){u.relativePath=h.substring(1),s.push(u),p()}function c(u){throw p(),u}function p(){--i==0&&t.addFiles(s,e)}},generateUniqueIdentifier:function(e){var t=this.opts.generateUniqueIdentifier;if(typeof t=="function")return t(e);var i=e.relativePath||e.webkitRelativePath||e.fileName||e.name;return e.size+"-"+i.replace(/[^0-9a-zA-Z_-]/img,"")},uploadNextChunk:function(e){var t=!1;if(this.opts.prioritizeFirstAndLastChunk&&(r(this.files,function(s){if(!s.paused&&s.chunks.length&&s.chunks[0].status()==="pending")return s.chunks[0].send(),t=!0,!1;if(!s.paused&&s.chunks.length>1&&s.chunks[s.chunks.length-1].status()==="pending")return s.chunks[s.chunks.length-1].send(),t=!0,!1}),t))return t;if(r(this.files,function(s){if(s.paused||r(s.chunks,function(n){if(n.status()==="pending")return n.send(),t=!0,!1}),t)return!1}),t)return!0;var i=!1;return r(this.files,function(s){if(!s.isComplete())return i=!0,!1}),!i&&!e&&j(function(){this.fire("complete")},this),!1},assignBrowse:function(e,t,i,s){e instanceof Element&&(e=[e]),r(e,function(n){var a;n.tagName==="INPUT"&&n.type==="file"?a=n:(a=d.createElement("input"),a.setAttribute("type","file"),l(a.style,{visibility:"hidden",position:"absolute",width:"1px",height:"1px"}),n.appendChild(a),n.addEventListener("click",function(){a.click()},!1)),!this.opts.singleFile&&!i&&a.setAttribute("multiple","multiple"),t&&a.setAttribute("webkitdirectory","webkitdirectory"),r(s,function(p,u){a.setAttribute(u,p)});var c=this;a.addEventListener("change",function(p){p.target.value&&(c.addFiles(p.target.files,p),p.target.value="")},!1)},this)},assignDrop:function(e){typeof e.length>"u"&&(e=[e]),r(e,function(t){t.addEventListener("dragover",this.preventEvent,!1),t.addEventListener("dragenter",this.preventEvent,!1),t.addEventListener("drop",this.onDrop,!1)},this)},unAssignDrop:function(e){typeof e.length>"u"&&(e=[e]),r(e,function(t){t.removeEventListener("dragover",this.preventEvent),t.removeEventListener("dragenter",this.preventEvent),t.removeEventListener("drop",this.onDrop)},this)},isUploading:function(){var e=!1;return r(this.files,function(t){if(t.isUploading())return e=!0,!1}),e},_shouldUploadNext:function(){var e=0,t=!0,i=this.opts.simultaneousUploads;return r(this.files,function(s){r(s.chunks,function(n){if(n.status()==="uploading"&&(e++,e>=i))return t=!1,!1})}),t&&e},upload:function(){var e=this._shouldUploadNext();if(e!==!1){this.fire("uploadStart");for(var t=!1,i=1;i<=this.opts.simultaneousUploads-e;i++)t=this.uploadNextChunk(!0)||t;t||j(function(){this.fire("complete")},this)}},resume:function(){r(this.files,function(e){e.isComplete()||e.resume()})},pause:function(){r(this.files,function(e){e.pause()})},cancel:function(){for(var e=this.files.length-1;e>=0;e--)this.files[e].cancel()},progress:function(){var e=0,t=0;return r(this.files,function(i){e+=i.progress()*i.size,t+=i.size}),t>0?e/t:0},addFile:function(e,t){this.addFiles([e],t)},addFiles:function(e,t){var i=[];r(e,function(s){if((!f||f&&s.size>0)&&!(s.size%4096===0&&(s.name==="."||s.fileName==="."))){var n=this.generateUniqueIdentifier(s);if(this.opts.allowDuplicateUploads||!this.getFromUniqueIdentifier(n)){var a=new w(this,s,n);this.fire("fileAdded",a,t)&&i.push(a)}}},this),this.fire("filesAdded",i,t)&&(r(i,function(s){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(s)},this),this.fire("filesSubmitted",i,t))},removeFile:function(e){for(var t=this.files.length-1;t>=0;t--)this.files[t]===e&&(this.files.splice(t,1),e.abort(),this.fire("fileRemoved",e))},getFromUniqueIdentifier:function(e){var t=!1;return r(this.files,function(i){i.uniqueIdentifier===e&&(t=i)}),t},getSize:function(){var e=0;return r(this.files,function(t){e+=t.size}),e},sizeUploaded:function(){var e=0;return r(this.files,function(t){e+=t.sizeUploaded()}),e},timeRemaining:function(){var e=0,t=0;return r(this.files,function(i){!i.paused&&!i.error&&(e+=i.size-i.sizeUploaded(),t+=i.averageSpeed)}),e&&!t?Number.POSITIVE_INFINITY:!e&&!t?0:Math.floor(e/t)}};function w(e,t,i){this.flowObj=e,this.bytes=null,this.file=t,this.name=t.fileName||t.name,this.size=t.size,this.relativePath=t.relativePath||t.webkitRelativePath||this.name,this.uniqueIdentifier=i===b?e.generateUniqueIdentifier(t):i,this.chunkSize=0,this.chunks=[],this.paused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevUploadedSize=0,this._prevProgress=0,this.bootstrap()}w.prototype={measureSpeed:function(){var e=Date.now()-this._lastProgressCallback;if(e){var t=this.flowObj.opts.speedSmoothingFactor,i=this.sizeUploaded();this.currentSpeed=Math.max((i-this._prevUploadedSize)/e*1e3,0),this.averageSpeed=t*this.currentSpeed+(1-t)*this.averageSpeed,this._prevUploadedSize=i}},chunkEvent:function(e,t,i){switch(t){case"progress":if(Date.now()-this._lastProgressCallback<this.flowObj.opts.progressCallbacksInterval)break;this.measureSpeed(),this.flowObj.fire("fileProgress",this,e),this.flowObj.fire("progress"),this._lastProgressCallback=Date.now();break;case"error":this.error=!0,this.abort(!0),this.flowObj.fire("fileError",this,i,e),this.flowObj.fire("error",i,this,e);break;case"success":if(this.error)return;this.measureSpeed(),this.flowObj.fire("fileProgress",this,e),this.flowObj.fire("progress"),this._lastProgressCallback=Date.now(),this.isComplete()&&(this.currentSpeed=0,this.averageSpeed=0,this.flowObj.fire("fileSuccess",this,i,e));break;case"retry":this.flowObj.fire("fileRetry",this,e);break}},pause:function(){this.paused=!0,this.abort()},resume:function(){this.paused=!1,this.flowObj.upload()},abort:function(e){this.currentSpeed=0,this.averageSpeed=0;var t=this.chunks;e&&(this.chunks=[]),r(t,function(i){i.status()==="uploading"&&(i.abort(),this.flowObj.uploadNextChunk())},this)},cancel:function(){this.flowObj.removeFile(this)},retry:function(){this.bootstrap(),this.flowObj.upload()},bootstrap:function(){typeof this.flowObj.opts.initFileFn=="function"&&this.flowObj.opts.initFileFn(this),this.abort(!0),this.error=!1,this._prevProgress=0;var e=this.flowObj.opts.forceChunkSize?Math.ceil:Math.floor;this.chunkSize=g(this.flowObj.opts.chunkSize,this);for(var t=Math.max(e(this.size/this.chunkSize),1),i=0;i<t;i++)this.chunks.push(new O(this.flowObj,this,i))},progress:function(){if(this.error)return 1;if(this.chunks.length===1)return this._prevProgress=Math.max(this._prevProgress,this.chunks[0].progress()),this._prevProgress;var e=0;r(this.chunks,function(i){e+=i.progress()*(i.endByte-i.startByte)});var t=e/this.size;return this._prevProgress=Math.max(this._prevProgress,t>.9999?1:t),this._prevProgress},isUploading:function(){var e=!1;return r(this.chunks,function(t){if(t.status()==="uploading")return e=!0,!1}),e},isComplete:function(){var e=!1;return r(this.chunks,function(t){var i=t.status();if(i==="pending"||i==="uploading"||i==="reading"||t.preprocessState===1||t.readState===1)return e=!0,!1}),!e},sizeUploaded:function(){var e=0;return r(this.chunks,function(t){e+=t.sizeUploaded()}),e},timeRemaining:function(){if(this.paused||this.error)return 0;var e=this.size-this.sizeUploaded();return e&&!this.averageSpeed?Number.POSITIVE_INFINITY:!e&&!this.averageSpeed?0:Math.floor(e/this.averageSpeed)},getType:function(){return this.file.type&&this.file.type.split("/")[1]},getExtension:function(){return this.name.substr((~-this.name.lastIndexOf(".")>>>0)+2).toLowerCase()}};function k(e,t,i,s,n){var a="slice";e.file.slice?a="slice":e.file.mozSlice?a="mozSlice":e.file.webkitSlice&&(a="webkitSlice"),n.readFinished(e.file[a](t,i,s))}function O(e,t,i){this.flowObj=e,this.fileObj=t,this.offset=i,this.tested=!1,this.retries=0,this.pendingRetry=!1,this.preprocessState=0,this.readState=0,this.loaded=0,this.total=0,this.chunkSize=this.fileObj.chunkSize,this.startByte=this.offset*this.chunkSize,this.filename=null,this.computeEndByte=function(){var n=Math.min(this.fileObj.size,(this.offset+1)*this.chunkSize);return this.fileObj.size-n<this.chunkSize&&!this.flowObj.opts.forceChunkSize&&(n=this.fileObj.size),n},this.endByte=this.computeEndByte(),this.xhr=null;var s=this;this.event=function(n,a){a=Array.prototype.slice.call(arguments),a.unshift(s),s.fileObj.chunkEvent.apply(s.fileObj,a)},this.progressHandler=function(n){n.lengthComputable&&(s.loaded=n.loaded,s.total=n.total),s.event("progress",n)},this.testHandler=function(n){var a=s.status(!0);a==="error"?(s.event(a,s.message()),s.flowObj.uploadNextChunk()):a==="success"?(s.tested=!0,s.event(a,s.message()),s.flowObj.uploadNextChunk()):s.fileObj.paused||(s.tested=!0,s.send())},this.doneHandler=function(n){var a=s.status();if(a==="success"||a==="error")delete this.data,s.event(a,s.message()),s.flowObj.uploadNextChunk();else if(!s.fileObj.paused){s.event("retry",s.message()),s.pendingRetry=!0,s.abort(),s.retries++;var c=s.flowObj.opts.chunkRetryInterval;c!==null?setTimeout(function(){s.send()},c):s.send()}}}O.prototype={getParams:function(){return{flowChunkNumber:this.offset+1,flowChunkSize:this.chunkSize,flowCurrentChunkSize:this.endByte-this.startByte,flowTotalSize:this.fileObj.size,flowIdentifier:this.fileObj.uniqueIdentifier,flowFilename:this.fileObj.name,flowRelativePath:this.fileObj.relativePath,flowTotalChunks:this.fileObj.chunks.length}},getTarget:function(e,t){return t.length==0?e:(e.indexOf("?")<0?e+="?":e+="&",e+t.join("&"))},test:function(){this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",this.testHandler,!1),this.xhr.addEventListener("error",this.testHandler,!1);var e=g(this.flowObj.opts.testMethod,this.fileObj,this),t=this.prepareXhrRequest(e,!0);this.xhr.send(t)},preprocessFinished:function(){this.endByte=this.computeEndByte(),this.preprocessState=2,this.send()},readFinished:function(e){this.readState=2,this.bytes=e,this.send()},send:function(){var e=this.flowObj.opts.preprocess,t=this.flowObj.opts.readFileFn;if(typeof e=="function")switch(this.preprocessState){case 0:this.preprocessState=1,e(this);return;case 1:return}switch(this.readState){case 0:this.readState=1,t(this.fileObj,this.startByte,this.endByte,this.fileObj.file.type,this);return;case 1:return}if(this.flowObj.opts.testChunks&&!this.tested){this.test();return}this.loaded=0,this.total=0,this.pendingRetry=!1,this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",this.progressHandler,!1),this.xhr.addEventListener("load",this.doneHandler,!1),this.xhr.addEventListener("error",this.doneHandler,!1);var i=g(this.flowObj.opts.uploadMethod,this.fileObj,this),s=this.prepareXhrRequest(i,!1,this.flowObj.opts.method,this.bytes),n=this.flowObj.opts.changeRawDataBeforeSend;typeof n=="function"&&(s=n(this,s)),this.xhr.send(s)},abort:function(){var e=this.xhr;this.xhr=null,e&&e.abort()},status:function(e){return this.readState===1?"reading":this.pendingRetry||this.preprocessState===1?"uploading":this.xhr?this.xhr.readyState<4?"uploading":this.flowObj.opts.successStatuses.indexOf(this.xhr.status)>-1?"success":this.flowObj.opts.permanentErrors.indexOf(this.xhr.status)>-1||!e&&this.retries>=this.flowObj.opts.maxChunkRetries?"error":(this.abort(),"pending"):"pending"},message:function(){return this.xhr?this.xhr.responseText:""},progress:function(){if(this.pendingRetry)return 0;var e=this.status();return e==="success"||e==="error"?1:e==="pending"?0:this.total>0?this.loaded/this.total:0},sizeUploaded:function(){var e=this.endByte-this.startByte;return this.status()!=="success"&&(e=this.progress()*e),e},prepareXhrRequest:function(e,t,i,s){var n=g(this.flowObj.opts.query,this.fileObj,this,t);n=l(n||{},this.getParams());var a=g(this.flowObj.opts.target,this.fileObj,this,t),c=null;if(e==="GET"||i==="octet"){var p=[];r(n,function(u,h){p.push([encodeURIComponent(h),encodeURIComponent(u)].join("="))}),a=this.getTarget(a,p),c=s||null}else c=new FormData,r(n,function(u,h){c.append(h,u)}),typeof s<"u"&&c.append(this.flowObj.opts.fileParameterName,s,this.filename||this.fileObj.file.name);return this.xhr.open(e,a,!0),this.xhr.withCredentials=this.flowObj.opts.withCredentials,r(g(this.flowObj.opts.headers,this.fileObj,this,t),function(u,h){this.xhr.setRequestHeader(h,u)},this),c}};function x(e,t){var i=e.indexOf(t);i>-1&&e.splice(i,1)}function g(e,t){return typeof e=="function"&&(t=Array.prototype.slice.call(arguments),e=e.apply(null,t.slice(1))),e}o.evalOpts=g;function j(e,t){setTimeout(e.bind(t),0)}function l(e,t){return r(arguments,function(i){i!==e&&r(i,function(s,n){e[n]=s})}),e}o.extend=l;function r(e,t,i){if(e){var s;if(typeof e.length<"u"){for(s=0;s<e.length;s++)if(t.call(i,e[s],s)===!1)return}else for(s in e)if(e.hasOwnProperty(s)&&t.call(i,e[s],s)===!1)return}}o.each=r,o.FlowFile=w,o.FlowChunk=O,o.version="<%= version %>",F?F.exports=o:v.Flow=o})(typeof window<"u"&&window,typeof document<"u"&&document)})(E)),E.exports}var se=te();const ie=M(se),re={class:"flow-upload"},ne={class:"upload-progress"},ae=["id"],oe={class:"fileuploadname m-0"},le={key:0,class:"progress h-20 my-1"},ue=["aria-valuenow"],he={key:1,class:"upload-status"},fe={class:"size"},ye=X({__name:"FlowUpload",props:{targetUrl:{},allowMultiple:{type:Boolean,default:!1},directoryMode:{type:Boolean,default:!1},validMimeTypes:{default:()=>["*"]},flowConfiguration:{default:()=>({})}},emits:["complete","success","error"],setup(F,{emit:v}){const d=F,b=v;let f=null;const o=G({value:{},push(l){this.value[l.uniqueIdentifier]={name:l.name,uniqueIdentifier:l.uniqueIdentifier,size:B(l.size),isVisible:!0,isCompleted:!1,progressPercent:0,targetUrl:d.targetUrl}},get(l){return this.value[l.uniqueIdentifier]??{}},hideAll(){H(this.value,l=>{l.isVisible=!1})},reset(){this.value={}}}),w=D("$fileBrowseTarget"),k=D("$fileDropTarget"),{apiCsrf:O}=q(),{$gettext:x}=N(),g=l=>{const r=l.target;r.classList.contains("file-drop-target")&&r.classList.add("drag_over")},j=l=>{const r=l.target;r.classList.contains("file-drop-target")&&r.classList.remove("drag_over")};return J(()=>{const l={target:e=>o.get(e).targetUrl??d.targetUrl,singleFile:!d.allowMultiple,headers:{Accept:"application/json","X-API-CSRF":O},withCredentials:!0,allowDuplicateUploads:!0,fileParameterName:"file_data",uploadMethod:"POST",testMethod:"GET",method:"multipart",maxChunkRetries:3,testChunks:!1},r=$({},d.flowConfiguration,l);f=new ie(r),f.assignBrowse(w.value,d.directoryMode,!d.allowMultiple,{accept:d.validMimeTypes.join(",")}),k.value&&f.assignDrop(k.value),f.on("fileAdded",e=>(o.push(e),!0)),f.on("filesSubmitted",()=>{f?.upload()}),f.on("fileProgress",e=>{o.get(e).progressPercent=V(e.progress()*100)}),f.on("fileSuccess",(e,t)=>{o.get(e).isCompleted=!0;let i;try{i=JSON.parse(t)}catch{i=null}b("success",e,i)}),f.on("error",(e,t,i)=>{console.error(e,t,i);let s=x("Could not upload file.");try{if(typeof e<"u"){const n=JSON.parse(e);typeof n.message<"u"&&(s=n.message,s.indexOf(": ")>-1&&(s=s.split(": ")[1]))}}catch{}o.get(t).error=s,b("error",t,s)}),f.on("complete",()=>{setTimeout(()=>{o.hideAll()},2e3),b("complete")})}),Y(()=>{f=null,o.reset()}),(l,r)=>(S(),y("div",re,[m("div",ne,[(S(!0),y(U,null,Z(o.value,(e,t)=>(S(),y(U,{key:t},[e.isVisible?(S(),y("div",{key:0,id:"file_upload_"+e.uniqueIdentifier,class:K(["uploading-file pt-1",{"text-success":e.isCompleted,"text-danger":e.error}])},[m("h6",oe,C(e.name),1),e.isCompleted?_("",!0):(S(),y("div",le,[m("div",{class:"progress-bar h-20",role:"progressbar",style:Q({width:e.progressPercent+"%"}),"aria-valuenow":e.progressPercent,"aria-valuemin":"0","aria-valuemax":"100"},null,12,ue)])),e.error?(S(),y("div",he,C(e.error),1)):_("",!0),m("div",fe,C(e.size),1)],10,ae)):_("",!0)],64))),128))]),m("div",{ref_key:"$fileDropTarget",ref:k,class:"file-drop-target",onDragenter:g,onDragleave:j},[W(C(P(x)("Drag file(s) here to upload or"))+" ",1),m("button",{ref_key:"$fileBrowseTarget",ref:w,type:"button",class:"file-upload btn btn-primary text-center ms-1"},[ee(A,{icon:P(L)},null,8,["icon"]),m("span",null,C(P(x)("Select File")),1)],512),r[0]||(r[0]=m("small",{class:"file-name"},null,-1))],544)]))}});export{ye as _};
