import{u as P,f as Y,R as tt,g as et,j as at}from"./layout-CUzOT8aY.js";import{_ as ot}from"./Loading-CQdAiB8R.js";import{g as R,Q as E,a as K}from"./useStationQuery-ClAZEJp_.js";import{_ as O,e as st,R as lt,y as it}from"./icons-BAjd3tML.js";import{_ as nt}from"./DataTable-BhAO7RbG.js";import{u as q,_ as Q}from"./useHasModal-Bq3QxExQ.js";import{d as A,g as z,m as D,o as u,e as c,a,t as i,r as N,q as rt,b as o,c as b,i as U,u as t,s as Z,k as ut,L as ct,M as dt,w as pt,v as mt,l as _t,f as j,F as G,p as ft}from"./vue-BsfewpWM.js";import{f as bt}from"./formatFileSize--9DaIXge.js";import{_ as V}from"./FormGroupField-K9S4Sadl.js";import{_ as gt}from"./ModalForm-D0z4l5nm.js";import{_ as W}from"./FormFieldset-DUBDY7k3.js";import{m as kt}from"./mergeExisting-B6FvxI3v.js";import{_ as I}from"./FormGroupCheckbox-ZsJmXmB6.js";import{_ as yt}from"./TimeCode-5-wAv2hi.js";import{_ as $t}from"./FormGroupMultiCheck-z3kTFzdV.js";import{_ as J}from"./FormGroupSelect-Cp69W3Gu.js";import{u as X}from"./regle-hGsoY2W9.js";import{I as vt}from"./InvisibleSubmitButton-NGv_v7G8.js";import{_ as ht}from"./StreamingLogView-DMGIufU5.js";import{_ as wt}from"./EnabledBadge-BJcmite3.js";import{u as Bt}from"./useConfirmAndDelete-CuQodV6V.js";import{_ as F}from"./CardPage-Cth3uewv.js";import{u as xt}from"./luxon-m3VuE4xT.js";import{u as St}from"./useApiItemProvider-DAIhDonu.js";import"./leaflet-DkUWBo0d.js";import"./estoolkit-DCzBkaPJ.js";import"./hlsjs-BVyhFw5s.js";import"./bootstrap.esm-30QIU_ZL.js";import"./vue-router-Cafqdr3I.js";import"./FormMultiCheck-RiRcopXY.js";import"./map-Caxea7Kw.js";import"./isArrayLike-DknTMkCU.js";import"./iteratee-DJRL6CbS.js";import"./FormCheckbox-Cc7beVle.js";import"./isTypedArray-By1PpNM0.js";import"./some-B0KiPFWm.js";import"./forEach-BFcv9GyE.js";import"./FormGroup-DXDHSoyc.js";import"./ValidationError-DsAp6Fjg.js";import"./useSlotsExcept-Dp0PSXNw.js";import"./zxcvbn-Bgw4VUEj.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./InfoCard-D5Q671bF.js";import"./luxon-F75Z0klY.js";const Ct={id:"modal-log-view-contents",class:"form-control log-viewer",style:{height:"300px","overflow-y":"auto"}},Lt=A({__name:"LastOutputModal",props:{lastOutput:{}},setup(x,{expose:v}){const m=z("$modal"),{show:g}=q(m);return v({show:g}),(k,d)=>(u(),D(Q,{id:"log_view_modal",ref_key:"$modal",ref:m,size:"md",title:k.$gettext("Log Viewer")},{default:c(()=>[a("pre",Ct,i(k.lastOutput),1)]),_:1},8,["title"]))}}),zt={class:"row g-3 mb-3"},Mt={key:0,class:"row g-3"},Rt=A({__name:"ConfigureModal",props:{settingsUrl:{},storageLocations:{}},emits:["relist"],setup(x,{expose:v,emit:m}){const g=x,k=m,d=N(!0),_=N({backup_enabled:!1,backup_time_code:null,backup_exclude_media:!1,backup_keep_copies:2,backup_storage_location:null,backup_format:null}),{r$:e}=X(_,{},{}),w=()=>e.$reset({toOriginalState:!0}),h=rt(()=>[{value:"zip",text:"Zip"},{value:"tgz",text:"TarGz"},{value:"tzst",text:"ZStd"}]),{axios:f}=P(),n=z("$modal"),{hide:C,show:B}=q(n),S=()=>{k("relist"),C()},M=async()=>{w(),d.value=!0,B();try{const{data:s}=await f.get(g.settingsUrl);e.$reset({toState:kt(e.$value,s)}),d.value=!1}catch{S()}},l=()=>{M()},{notifySuccess:r}=Y(),$=async()=>{const{valid:s,data:T}=await e.$validate();s&&(await f({method:"PUT",url:g.settingsUrl,data:T}),r(),S())};return v({open:l}),(s,T)=>(u(),D(gt,{ref_key:"$modal",ref:n,size:"lg",title:s.$gettext("Configure Backups"),loading:d.value,"disable-save-button":t(e).$invalid,onSubmit:$,onHidden:w},{default:c(()=>[o(W,null,{default:c(()=>[a("div",zt,[o(I,{id:"form_edit_backup_enabled",class:"col-md-12",field:t(e).backup_enabled,label:s.$gettext("Run Automatic Nightly Backups"),description:s.$gettext("Enable to have AzuraCast automatically run nightly backups at the time specified.")},null,8,["field","label","description"])]),_.value.backup_enabled?(u(),b("div",Mt,[o(V,{id:"form_backup_time_code",class:"col-md-6",field:t(e).backup_time_code,label:s.$gettext("Scheduled Backup Time"),description:s.$gettext("Backup times are always in UTC.")},{default:c(({id:p,model:y,fieldClass:L})=>[o(yt,{id:p,modelValue:y.$model,"onUpdate:modelValue":H=>y.$model=H,class:Z(L)},null,8,["id","modelValue","onUpdate:modelValue","class"])]),_:1},8,["field","label","description"]),o(I,{id:"form_edit_exclude_media",class:"col-md-6",field:t(e).backup_exclude_media,label:s.$gettext("Exclude Media from Backup"),description:s.$gettext("Excluding media from automated backups will save space, but you should make sure to back up your media elsewhere. Note that only locally stored media will be backed up.")},null,8,["field","label","description"]),o(V,{id:"form_backup_keep_copies",class:"col-md-6",field:t(e).backup_keep_copies,"input-type":"number","input-attrs":{min:"0",max:"365"},label:s.$gettext("Number of Backup Copies to Keep"),description:s.$gettext("Copies older than the specified number of days will automatically be deleted. Set to zero to disable automatic deletion.")},null,8,["field","label","description"]),o(J,{id:"edit_form_backup_storage_location",class:"col-md-6",field:t(e).backup_storage_location,label:s.$gettext("Storage Location"),options:s.storageLocations},null,8,["field","label","options"]),o($t,{id:"edit_form_backup_format",class:"col-md-6",field:t(e).backup_format,stacked:"",radio:"",options:h.value,label:s.$gettext("Backup Format")},null,8,["field","options","label"])])):U("",!0)]),_:1})]),_:1},8,["title","loading","disable-save-button"]))}}),Ut={class:"row g-3"},At={class:"m-0"},Tt={key:1},Nt=A({__name:"RunBackupModal",props:{runBackupUrl:{},storageLocations:{}},emits:["relist"],setup(x,{expose:v,emit:m}){const g=x,k=m,d=N(null),_=N(null),e=z("$modal"),{show:w,hide:h}=q(e),f={storage_location:null,path:"",exclude_media:!1},{r$:n}=X(f,{storage_location:{},path:{},exclude_media:{}},{}),{axios:C}=P(),B=async()=>{const{valid:l,data:r}=await n.$validate();if(l)try{const{data:$}=await C.post(g.runBackupUrl,r);d.value=$.logUrl}catch($){_.value=tt($)}},S=()=>{d.value=null,_.value=null,n.$reset({toOriginalState:!0})},M=()=>{S(),k("relist")};return v({open:w}),(l,r)=>(u(),D(Q,{id:"run_backup_modal",ref_key:"$modal",ref:e,size:"md",centered:"",title:l.$gettext("Run Manual Backup"),onHidden:M},{default:c(()=>[pt(a("div",{class:"alert alert-danger"},i(_.value),513),[[mt,_.value!=null]]),d.value===null?(u(),b("form",{key:0,class:"form vue-form",onSubmit:_t(B,["prevent"])},[o(W,null,{default:c(()=>[a("div",Ut,[o(J,{id:"edit_form_storage_location",class:"col-md-12",field:t(n).storage_location,options:l.storageLocations,label:l.$gettext("Storage Location")},null,8,["field","options","label"]),o(V,{id:"edit_form_path",class:"col-md-12",field:t(n).path,label:l.$gettext("File Name")},{description:c(()=>[j(i(l.$gettext("This will be the file name for your backup, include the extension for file type you wish to use. Leave blank to have a name generated automatically."))+" ",1),r[3]||(r[3]=a("br",null,null,-1)),a("strong",null,i(l.$gettext("Supported file formats:")),1),r[4]||(r[4]=a("br",null,null,-1)),a("ul",At,[r[1]||(r[1]=a("li",null,".zip",-1)),r[2]||(r[2]=a("li",null,".tar.gz",-1)),a("li",null," .tzst ( "+i(l.$gettext("ZStandard compression"))+" ) ",1)])]),_:1},8,["field","label"]),o(I,{id:"edit_form_exclude_media",class:"col-md-12",field:t(n).exclude_media,label:l.$gettext("Exclude Media from Backup"),description:l.$gettext("This will produce a significantly smaller backup, but you should make sure to back up your media elsewhere. Note that only locally stored media will be backed up.")},null,8,["field","label","description"])])]),_:1}),o(vt)],32)):(u(),b("div",Tt,[o(ht,{"log-url":d.value},null,8,["log-url"])]))]),"modal-footer":c($=>[ut(l.$slots,"modal-footer",ct(dt($)),()=>[a("button",{type:"button",class:"btn btn-secondary",onClick:r[0]||(r[0]=(...s)=>t(h)&&t(h)(...s))},i(l.$gettext("Close")),1),d.value===null?(u(),b("button",{key:0,class:Z(["btn",t(n).$invalid?"btn-danger":"btn-primary"]),type:"submit",onClick:B},i(l.$gettext("Run Manual Backup")),3)):U("",!0)])]),_:3},8,["title"]))}}),Dt={class:"row row-of-cards"},Ot={class:"col-md-6"},Ft=["id"],Et={key:0,class:"card-body"},Vt={key:0,class:"card-text"},It={key:1,class:"card-text"},Pt={class:"col-md-6"},qt={class:"card-body"},Ht={class:"card-text"},Kt={key:0},Qt={key:1},Zt={class:"card-text text-warning"},jt={class:"btn-group btn-group-sm"},Gt=["href"],Wt=["onClick"],Jt=A({__name:"Backups",props:{isDocker:{type:Boolean},storageLocations:{},settings:{}},emits:["relist"],setup(x,{emit:v}){const m=x,g=v,k=R("/admin/backups"),d=R("/admin/backups/run"),_=R("/admin/settings/backup"),{$gettext:e}=et(),{timeConfig:w}=at(),{DateTime:h,timestampToRelative:f}=xt(),n=[{key:"basename",isRowHeader:!0,label:e("File Name"),sortable:!1},{key:"timestamp",label:e("Last Modified"),sortable:!1,formatter:p=>h.fromSeconds(p).toLocaleString({...h.DATETIME_SHORT,...w})},{key:"size",label:e("Size"),sortable:!1,formatter:p=>bt(p)},{key:"actions",label:e("Actions"),sortable:!1,class:"shrink"}],C=St(k,[E.AdminBackups]),B=async()=>{await C.refresh(),g("relist")},S=z("$lastOutputModal"),M=()=>{S.value?.show()},l=z("$configureModal"),r=()=>{l.value?.open()},$=z("$runBackupModal"),s=()=>{$.value?.open()},{doDelete:T}=Bt(e("Delete Backup?"),()=>{B()});return(p,y)=>(u(),b(G,null,[a("div",Dt,[a("div",Ot,[o(F,{"header-id":"hdr_automatic_backups"},{header:c(({id:L})=>[a("h2",{id:L,class:"card-title"},[j(i(t(e)("Automatic Backups"))+" ",1),o(wt,{enabled:p.settings.backup_enabled},null,8,["enabled"])],8,Ft)]),footer_actions:c(()=>[a("button",{type:"button",class:"btn btn-primary",onClick:r},[o(O,{icon:t(st)},null,8,["icon"]),a("span",null,i(t(e)("Configure")),1)]),p.settings.backup_enabled&&p.settings.backup_last_output!==""?(u(),b("button",{key:0,type:"button",class:"btn btn-secondary",onClick:M},[o(O,{icon:t(lt)},null,8,["icon"]),a("span",null,i(t(e)("Most Recent Backup Log")),1)])):U("",!0)]),default:c(()=>[p.settings.backup_enabled?(u(),b("div",Et,[p.settings.backup_last_run>0?(u(),b("p",Vt,i(t(e)("Last run:"))+" "+i(t(f)(p.settings.backup_last_run)),1)):(u(),b("p",It,i(t(e)("Never run")),1))])):U("",!0)]),_:1})]),a("div",Pt,[o(F,{"header-id":"hdr_restoring_backups",title:t(e)("Restoring Backups")},{default:c(()=>[a("div",qt,[a("p",Ht,i(t(e)("To restore a backup from your host computer, run:")),1),m.isDocker?(u(),b("pre",Kt,[...y[2]||(y[2]=[a("code",null,"./docker.sh restore path_to_backup.zip",-1)])])):(u(),b("pre",Qt,[...y[3]||(y[3]=[a("code",null,"/var/azuracast/www/bin/console azuracast:restore path_to_backup.zip",-1)])])),a("p",Zt,i(t(e)("Note that restoring a backup will clear your existing database. Never restore backup files from untrusted users.")),1)])]),_:1},8,["title"])])]),o(F,{"header-id":"hdr_backups",title:t(e)("Backups")},{actions:c(()=>[a("button",{type:"button",class:"btn btn-primary",onClick:s},[o(O,{icon:t(it)},null,8,["icon"]),a("span",null,i(t(e)("Run Manual Backup")),1)])]),default:c(()=>[o(nt,{id:"api_keys",fields:n,provider:t(C)},{"cell(actions)":c(L=>[a("div",jt,[a("a",{class:"btn btn-primary",href:L.item.links.download,target:"_blank"},i(t(e)("Download")),9,Gt),a("button",{type:"button",class:"btn btn-danger",onClick:H=>t(T)(L.item.links.delete)},i(t(e)("Delete")),9,Wt)])]),_:1},8,["provider"])]),_:1},8,["title"]),o(Rt,{ref_key:"$configureModal",ref:l,"settings-url":t(_),"storage-locations":m.storageLocations,onRelist:y[0]||(y[0]=()=>B())},null,8,["settings-url","storage-locations"]),o(Nt,{ref_key:"$runBackupModal",ref:$,"run-backup-url":t(d),"storage-locations":m.storageLocations,onRelist:y[1]||(y[1]=()=>B())},null,8,["run-backup-url","storage-locations"]),o(Lt,{ref_key:"$lastOutputModal",ref:S,"last-output":p.settings.backup_last_output??""},null,8,["last-output"])],64))}}),Xt={class:"outside-card-header mb-1"},qe=A({__name:"BackupsWrapper",setup(x){const v=R("/admin/vue/backups"),m=R("/admin/settings/backup"),{axios:g}=P(),{data:k,isLoading:d}=K({queryKey:[E.AdminBackups,"props"],queryFn:async({signal:f})=>{const{data:n}=await g.get(v.value,{signal:f});return n}}),{data:_,isLoading:e,refetch:w}=K({queryKey:[E.AdminBackups,"settings"],queryFn:async({signal:f})=>{const{data:n}=await g.get(m.value,{signal:f});return n}}),h=async()=>{await w()};return(f,n)=>(u(),b(G,null,[a("h2",Xt,i(f.$gettext("Backups")),1),o(ot,{loading:t(d)||t(e),lazy:""},{default:c(()=>[t(k)&&t(_)?(u(),D(Jt,ft({key:0},t(k),{settings:t(_),onRelist:n[0]||(n[0]=()=>h())}),null,16,["settings"])):U("",!0)]),_:1},8,["loading"])],64))}});export{qe as default};
