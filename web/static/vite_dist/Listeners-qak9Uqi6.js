import{r as oe}from"./leaflet-DkUWBo0d.js";import{u as ie}from"./theme-BQjAlSn5.js";import{s as ae,g as J,ab as re,h as ue,u as ce}from"./layout-CUzOT8aY.js";import{d as x,g as q,G as de,h as me,B as R,c as _,o as f,k as N,i as S,K as fe,ag as pe,q as k,m as z,e as $,F as _e,D as ve,f as g,a as e,t as s,A as he,w as E,y as O,C as be,u as a,b,r as A,s as B}from"./vue-BsfewpWM.js";import{f as Q}from"./map-Caxea7Kw.js";import{_ as D,ae as ge,r as ye,N as ke,as as Le,at as Fe}from"./icons-BAjd3tML.js";import{_ as De,u as $e}from"./DataTable-BhAO7RbG.js";import{_ as xe}from"./DateRangeDropdown-7SFZkkqA.js";import{e as Ce,c as Te,a as Se,q as H,Q as K,b as Me}from"./useStationQuery-ClAZEJp_.js";import{u as we}from"./useStationDateTimeFormatter-CkmvkIuo.js";import{u as Ue}from"./luxon-m3VuE4xT.js";import{u as Ee}from"./useClientItemProvider-Ds0yxtsG.js";import"./estoolkit-DCzBkaPJ.js";import"./hlsjs-BVyhFw5s.js";import"./bootstrap.esm-30QIU_ZL.js";import"./isArrayLike-DknTMkCU.js";import"./iteratee-DJRL6CbS.js";import"./FormMultiCheck-RiRcopXY.js";import"./FormCheckbox-Cc7beVle.js";import"./isTypedArray-By1PpNM0.js";import"./some-B0KiPFWm.js";import"./forEach-BFcv9GyE.js";import"./vue-router-Cafqdr3I.js";import"./luxon-F75Z0klY.js";var F=oe();L.Control.Fullscreen=L.Control.extend({options:{position:"topleft",title:{false:"View Fullscreen",true:"Exit Fullscreen"}},onAdd:function(n){var t=L.DomUtil.create("div","leaflet-control-fullscreen leaflet-bar leaflet-control");return this.link=L.DomUtil.create("a","leaflet-control-fullscreen-button leaflet-bar-part",t),this.link.href="#",this._map=n,this._map.on("fullscreenchange",this._toggleTitle,this),this._toggleTitle(),L.DomEvent.on(this.link,"click",this._click,this),t},_click:function(n){L.DomEvent.stopPropagation(n),L.DomEvent.preventDefault(n),this._map.toggleFullscreen(this.options)},_toggleTitle:function(){this.link.title=this.options.title[this._map.isFullscreen()]}});L.Map.include({isFullscreen:function(){return this._isFullscreen||!1},toggleFullscreen:function(n){var t=this.getContainer();this.isFullscreen()?n&&n.pseudoFullscreen?this._disablePseudoFullscreen(t):document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():this._disablePseudoFullscreen(t):n&&n.pseudoFullscreen?this._enablePseudoFullscreen(t):t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):t.msRequestFullscreen?t.msRequestFullscreen():this._enablePseudoFullscreen(t)},_enablePseudoFullscreen:function(n){L.DomUtil.addClass(n,"leaflet-pseudo-fullscreen"),this._setFullscreen(!0),this.fire("fullscreenchange")},_disablePseudoFullscreen:function(n){L.DomUtil.removeClass(n,"leaflet-pseudo-fullscreen"),this._setFullscreen(!1),this.fire("fullscreenchange")},_setFullscreen:function(n){this._isFullscreen=n;var t=this.getContainer();n?L.DomUtil.addClass(t,"leaflet-fullscreen-on"):L.DomUtil.removeClass(t,"leaflet-fullscreen-on"),this.invalidateSize()},_onFullscreenChange:function(n){var t=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;t===this.getContainer()&&!this._isFullscreen?(this._setFullscreen(!0),this.fire("fullscreenchange")):t!==this.getContainer()&&this._isFullscreen&&(this._setFullscreen(!1),this.fire("fullscreenchange"))}});L.Map.mergeOptions({fullscreenControl:!1});L.Map.addInitHook(function(){this.options.fullscreenControl&&(this.fullscreenControl=new L.Control.Fullscreen(this.options.fullscreenControl),this.addControl(this.fullscreenControl));var n;if("onfullscreenchange"in document?n="fullscreenchange":"onmozfullscreenchange"in document?n="mozfullscreenchange":"onwebkitfullscreenchange"in document?n="webkitfullscreenchange":"onmsfullscreenchange"in document&&(n="MSFullscreenChange"),n){var t=L.bind(this._onFullscreenChange,this);this.whenReady(function(){L.DomEvent.on(document,n,t)}),this.on("unload",function(){L.DomEvent.off(document,n,t)})}});L.control.fullscreen=function(n){return new L.Control.Fullscreen(n)};const Ae=x({__name:"InnerMap",setup(n){const t=q("$container"),m=de(null),{currentTheme:i}=ae(ie()),{$gettext:r}=J();return me(()=>{F.Icon.Default.imagePath="/static/img/leaflet/";const u=F.map(t.value);u.setView([40,0],1),u.addControl(new F.Control.Fullscreen({title:{false:r("View Fullscreen"),true:r("Exit Fullscreen")}})),m.value=u;const p=()=>{if(!i.value)return;const M=`https://cartodb-basemaps-{s}.global.ssl.fastly.net/${i.value}_all/{z}/{x}/{y}.png`;F.tileLayer(M,{id:"main",attribution:"Map tiles by Carto, under CC BY 3.0. Data by OpenStreetMap, under ODbL."}).addTo(u)};p(),R(i,()=>{p()})}),(u,p)=>(f(),_("div",{id:"leaflet-container",ref_key:"$container",ref:t},[m.value?N(u.$slots,"default",{key:0,map:m.value}):S("",!0)],512))}}),Re=x({__name:"MapPoint",props:{map:{},position:{}},setup(n){const t=n,m=F.marker(t.position);R(fe(t,"map"),u=>{u!==null&&m.addTo(u)},{immediate:!0});const i=new F.Popup,r=q("$content");return R(r,u=>{u!==null&&(i.setContent(u),m.bindPopup(i))},{immediate:!0}),pe(()=>{m.remove()}),(u,p)=>(f(),_("div",{ref_key:"$content",ref:r},[N(u.$slots,"default")],512))}}),qe=x({__name:"Map",props:{listeners:{default:()=>[]}},setup(n){const t=n,m=k(()=>Q(t.listeners,function(i){return i.location.lat!==null&&i.location.lon!==null}));return(i,r)=>m.value.length<3e3?(f(),z(Ae,{key:0},{default:$(({map:u})=>[(f(!0),_(_e,null,ve(m.value,p=>(f(),z(Re,{key:p.hash,map:u,position:[p.location.lat,p.location.lon]},{default:$(()=>[g(s(i.$gettext("IP"))+" : "+s(p.ip),1),r[0]||(r[0]=e("br",null,null,-1)),g(" "+s(i.$gettext("Country"))+" : "+s(p.location.country),1),r[1]||(r[1]=e("br",null,null,-1)),g(" "+s(i.$gettext("Region"))+" : "+s(p.location.region),1),r[2]||(r[2]=e("br",null,null,-1)),g(" "+s(i.$gettext("City"))+" : "+s(p.location.city),1),r[3]||(r[3]=e("br",null,null,-1)),g(" "+s(i.$gettext("Time"))+" : "+s(p.connected_time),1),r[4]||(r[4]=e("br",null,null,-1)),g(" "+s(i.$gettext("User Agent"))+" : "+s(p.user_agent),1)]),_:2},1032,["map","position"]))),128))]),_:1})):S("",!0)}}),h=Object.freeze({All:"all",Mobile:"mobile",Desktop:"desktop",Bot:"bot"}),Ie={class:"row row-cols-md-auto g-3 align-items-center"},Pe={class:"col-12"},Ve={for:"minLength"},ze={class:"input-group input-group-sm"},Oe={class:"col-12"},Be={for:"maxLength"},He={class:"input-group input-group-sm"},Ke={class:"col-12"},Je={for:"type"},Ne={class:"input-group input-group-sm"},Qe=["value"],We=["value"],je=["value"],Ge=["value"],Ye={class:"col-12"},Xe=x({__name:"FiltersBar",props:{filters:{required:!0},filtersModifiers:{}},emits:["update:filters"],setup(n){const t=he(n,"filters"),m=()=>{t.value.minLength=null,t.value.maxLength=null,t.value.type=h.All};return(i,r)=>(f(),_("div",Ie,[e("div",Pe,[e("label",Ve,s(i.$gettext("Min. Connected Time")),1),e("div",ze,[E(e("input",{id:"minLength","onUpdate:modelValue":r[0]||(r[0]=u=>t.value.minLength=u),type:"number",class:"form-control",min:"0",step:"1"},null,512),[[O,t.value.minLength]])])]),e("div",Oe,[e("label",Be,s(i.$gettext("Max. Connected Time")),1),e("div",He,[E(e("input",{id:"maxLength","onUpdate:modelValue":r[1]||(r[1]=u=>t.value.maxLength=u),type:"number",class:"form-control",min:"0",step:"1"},null,512),[[O,t.value.maxLength]])])]),e("div",Ke,[e("label",Je,s(i.$gettext("Listener Type")),1),e("div",Ne,[E(e("select",{"onUpdate:modelValue":r[2]||(r[2]=u=>t.value.type=u),class:"form-select form-select-sm"},[e("option",{value:a(h).All},s(i.$gettext("All Types")),9,Qe),e("option",{value:a(h).Mobile},s(i.$gettext("Mobile")),9,We),e("option",{value:a(h).Desktop},s(i.$gettext("Desktop")),9,je),e("option",{value:a(h).Bot},s(i.$gettext("Bot/Crawler")),9,Ge)],512),[[be,t.value.type]])])]),e("div",Ye,[e("button",{type:"button",class:"btn btn-sm btn-secondary",onClick:m},[b(D,{icon:a(ge)},null,8,["icon"]),e("span",null,s(i.$gettext("Clear Filters")),1)])])]))}}),Ze={class:"row"},et={class:"col-sm-12"},tt={class:"card"},st={class:"card-header text-bg-primary"},lt={class:"d-lg-flex align-items-center"},nt={class:"flex-fill my-0"},ot={class:"card-title"},it={class:"flex-shrink buttons mt-2 mt-lg-0"},at=["href"],rt={key:0,class:"flex-shrink buttons ms-lg-2 mt-2 mt-lg-0"},ut={class:"card-body pb-0"},ct={class:"nav nav-tabs",role:"tablist"},dt={class:"nav-item",role:"presentation"},mt={class:"nav-item",role:"presentation"},ft={id:"map"},pt={class:"card-body"},_t={class:"row row-cols-md-auto align-items-center"},vt={class:"col-12 text-start text-md-end h5"},ht={class:"col-12 h3"},bt={class:"col-12 text-start text-md-end h5"},gt={class:"col-12 h3"},yt={class:"col-12"},kt={class:"d-flex align-items-center"},Lt={class:"flex-shrink-0 pe-2"},Ft={key:0},Dt={class:"visually-hidden"},$t={key:1},xt={class:"visually-hidden"},Ct={key:2},Tt={class:"visually-hidden"},St={class:"flex-fill"},Mt={key:0},wt={class:"small"},Ut={key:0},Et={key:1},At={key:0},Rt={key:1},qt={key:0},It={key:1},Pt=["innerHTML"],us=x({__name:"Listeners",setup(n){const t=Ce("/listeners"),m=A(!0),{DateTime:i}=Ue(),r=Te(),{timezone:u,ipGeoAttribution:p}=re(r),{now:M,formatTimestampAsDateTime:w}=we(),C=M(),W=C.minus({years:5}).toJSDate(),j=C.plus({days:5}).toJSDate(),y=A({startDate:C.minus({days:1}).toJSDate(),endDate:C.toJSDate()}),v=A({minLength:null,maxLength:null,type:h.All}),{$gettext:c}=J(),G=[{key:"ip",label:c("IP"),sortable:!1,selectable:!0,visible:!0},{key:"connected_time",label:c("Time"),sortable:!0,formatter:(d,o,l)=>ue(l.connected_time),selectable:!0,visible:!0},{key:"connected_time_sec",label:c("Time (sec)"),sortable:!1,formatter:(d,o,l)=>String(l.connected_time),selectable:!0,visible:!1},{key:"connected_on",label:c("Start Time"),sortable:!0,formatter:(d,o,l)=>w(l.connected_on,i.DATETIME_SHORT),selectable:!0,visible:!1},{key:"connected_until",label:c("End Time"),sortable:!0,formatter:(d,o,l)=>w(l.connected_until,i.DATETIME_SHORT),selectable:!0,visible:!1},{key:"device.client",isRowHeader:!0,label:c("User Agent"),sortable:!0,selectable:!0,visible:!0},{key:"stream",label:c("Stream"),sortable:!0,selectable:!0,visible:!0},{key:"location",label:c("Location"),sortable:!0,sorter:d=>d.location?.country+" "+d.location?.region+" "+d.location?.city,selectable:!0,visible:!0}],Y=k(()=>{const d=new URL(t.value,document.location.href),o=d.searchParams;if(o.set("format","csv"),!m.value){const l=i.fromJSDate(y.value.startDate);l.isValid&&o.set("start",l.toISO());const T=i.fromJSDate(y.value.endDate);T.isValid&&o.set("end",T.toISO())}return d.toString()}),{axios:X}=ce(),I=q("$dataTable"),{navigate:Z}=$e(I),ee=k(()=>v.value.minLength!==null||v.value.maxLength!==null||h.All!==v.value.type),{data:P,isLoading:te}=Se({queryKey:H([K.StationReports,"listeners",k(()=>m.value?"live":y.value)]),queryFn:async({signal:d})=>{const o={};m.value||(o.start=i.fromJSDate(y.value.startDate).toISO(),o.end=i.fromJSDate(y.value.endDate).toISO());const{data:l}=await X.get(t.value,{signal:d,params:o});return l},staleTime:10*1e3,refetchInterval:d=>[...d.options?.queryKey??[]].pop()==="live"?15e3:!1}),U=k(()=>{const d=P.value??[];return ee.value?Q(d,o=>{const l=o.connected_time;if(v.value.minLength!==null&&l<v.value.minLength||v.value.maxLength!==null&&l>v.value.maxLength)return!1;if(h.All!==v.value.type){if(h.Mobile===v.value.type&&!o.device.is_mobile)return!1;if(h.Desktop===v.value.type&&o.device.is_mobile)return!1}return!0}):d}),se=Me(),le=Ee(U,te,void 0,async()=>{await se.invalidateQueries({queryKey:H([K.StationReports,"listeners"])})}),ne=k(()=>{let d=0;const o=P.value??[];for(const T of o)d+=T.connected_time;const l=d/3600;return Math.round((l+1e-5)*100)/100}),V=d=>{m.value=d,Z()};return(d,o)=>(f(),_("div",Ze,[e("div",et,[e("div",tt,[e("div",st,[e("div",lt,[e("div",nt,[e("h2",ot,s(a(c)("Listeners")),1)]),e("div",it,[e("a",{id:"btn-export",class:"btn btn-dark",href:Y.value,target:"_blank"},[b(D,{icon:a(ye)},null,8,["icon"]),e("span",null,s(a(c)("Download CSV")),1)],8,at)]),m.value?S("",!0):(f(),_("div",rt,[b(xe,{modelValue:y.value,"onUpdate:modelValue":o[0]||(o[0]=l=>y.value=l),options:{timezone:a(u),enableTimePicker:!0,minDate:a(W),maxDate:a(j)},class:"btn-dark"},null,8,["modelValue","options"])]))])]),e("div",ut,[e("nav",ct,[e("div",dt,[e("button",{class:B(["nav-link",m.value?"active":""]),type:"button",role:"tab",onClick:o[1]||(o[1]=l=>V(!0))},s(a(c)("Live Listeners")),3)]),e("div",mt,[e("button",{class:B(["nav-link",m.value?"":"active"]),type:"button",role:"tab",onClick:o[2]||(o[2]=l=>V(!1))},s(a(c)("Listener History")),3)])])]),e("div",ft,[b(qe,{listeners:U.value},null,8,["listeners"])]),e("div",null,[e("div",pt,[e("div",_t,[e("div",vt,[g(s(a(c)("Unique Listeners"))+" ",1),o[4]||(o[4]=e("br",null,null,-1)),e("small",null,s(a(c)("for selected period")),1)]),e("div",ht,s(U.value.length),1),e("div",bt,[g(s(a(c)("Total Listener Hours"))+" ",1),o[5]||(o[5]=e("br",null,null,-1)),e("small",null,s(a(c)("for selected period")),1)]),e("div",gt,s(ne.value),1),e("div",yt,[b(Xe,{filters:v.value,"onUpdate:filters":o[3]||(o[3]=l=>v.value=l)},null,8,["filters"])])])]),b(De,{id:"station_listeners",ref_key:"$dataTable",ref:I,paginated:"",fields:G,provider:a(le),"select-fields":""},{"cell(device.client)":$(l=>[e("div",kt,[e("div",Lt,[l.item.device.is_bot?(f(),_("span",Ft,[b(D,{icon:a(ke)},null,8,["icon"]),e("span",Dt,s(a(c)("Bot/Crawler")),1)])):l.item.device.is_mobile?(f(),_("span",$t,[b(D,{icon:a(Le)},null,8,["icon"]),e("span",xt,s(a(c)("Mobile")),1)])):(f(),_("span",Ct,[b(D,{icon:a(Fe)},null,8,["icon"]),e("span",Tt,s(a(c)("Desktop")),1)]))]),e("div",St,[l.item.device.client?(f(),_("div",Mt,s(l.item.device.client),1)):S("",!0),e("div",wt,s(l.item.user_agent),1)])])]),"cell(stream)":$(l=>[l.item.mount_name===""?(f(),_("span",Ut,s(a(c)("Unknown")),1)):(f(),_("span",Et,[g(s(l.item.mount_name),1),o[6]||(o[6]=e("br",null,null,-1)),l.item.mount_is_local?(f(),_("small",At,s(a(c)("Local")),1)):(f(),_("small",Rt,s(a(c)("Remote")),1))]))]),"cell(location)":$(l=>[l.item.location.description?(f(),_("span",qt,s(l.item.location.description),1)):(f(),_("span",It,s(a(c)("Unknown")),1))]),_:1},8,["provider"])]),e("div",{class:"card-body card-padding-sm text-muted",innerHTML:a(p)},null,8,Pt)])])]))}});export{us as default};
